# Internal Directory

## Overview
Директория `internal` содержит основной код приложения, который не предназначен для использования вне этого сервиса. Структура следует принципам Clean Architecture и разделена на четыре основных слоя:

## Структура директорий

### application/
Слой приложения, содержащий реализацию бизнес-сценариев (use cases):
- **clv_service.go**: Оркестрация расчета пожизненной ценности клиента (CLV)
- **retention_service.go**: Управление прогнозированием удержания пользователей
- **segmentation-service.go**: Координация процессов сегментации пользователей
- **user_service.go**: Управление профилями пользователей

### domain/
Слой предметной области, содержащий бизнес-сущности и правила:

#### entities/
- **clv.go**: Структуры данных для CLV
- **segment.go**: Определение сегментов пользователей
- **transaction.go**: Записи о транзакциях пользователей
- **user-metrics.go**: Метрики поведения пользователей
- **user.go**: Профиль пользователя

#### repositories/
Интерфейсы для доступа к данным:
- **clv_repository.go**: Интерфейс для работы с данными CLV
- **segment_repository.go**: Интерфейс для работы с сегментами
- **transaction_repository.go**: Интерфейс для работы с транзакциями
- **user_metrics_repository.go**: Интерфейс для работы с метриками пользователей
- **user_repository.go**: Интерфейс для работы с профилями пользователей

#### services/
Интерфейсы бизнес-логики:
- **clv_service.go**: Интерфейс для расчета CLV
- **segmentation_service.go**: Интерфейс для сегментации пользователей
- **state_transition_service.go**: Интерфейс для моделирования переходов между состояниями
- **survival_analysis_service.go**: Интерфейс для анализа выживаемости

### infrastructure/
Слой инфраструктуры, содержащий конкретные реализации интерфейсов:

#### postgres/
Реализации репозиториев для PostgreSQL:
- **segment_repository.go**: Реализация SegmentRepository
- **transaction_repository.go**: Реализация TransactionRepository
- **user_metrics_repository.go**: Реализация UserMetricsRepository
- **user_repository.go**: Реализация UserRepository

#### services/
Реализации сервисов:
- **cox_survival_analysis.go**: Реализация анализа выживаемости по модели Кокса
- **discounted_clv_service.go**: Реализация расчета CLV методом дисконтированных денежных потоков
- **kmeans_segmentation.go**: Реализация сегментации методом K-means
- **markov_transition_service.go**: Реализация моделирования переходов по цепям Маркова

### interfaces/
Слой интерфейсов, отвечающий за взаимодействие с внешними системами:

#### http/
HTTP-интерфейс:
- **handlers/**: Обработчики HTTP-запросов
  - **clv_handler.go**: Обработчик запросов для CLV
  - **retention_handler.go**: Обработчик запросов для прогнозирования удержания
  - **segment_handler.go**: Обработчик запросов для сегментов
  - **user_handler.go**: Обработчик запросов для пользователей
- **router.go**: Настройка маршрутизации HTTP-запросов

#### kafka/
Интерфейс для работы с Kafka:
- **config.go**: Конфигурация Kafka
- **consumer.go**: Потребитель сообщений Kafka
- **health.go**: Проверка здоровья соединения с Kafka
- **producer.go**: Производитель сообщений Kafka

## Принципы организации кода
1. **Зависимости направлены внутрь**: Внешние слои зависят от внутренних, но не наоборот
2. **Инверсия зависимостей**: Внутренние слои определяют интерфейсы, которые реализуются внешними слоями
3. **Разделение ответственности**: Каждый компонент имеет четко определенную ответственность
4. **Инкапсуляция**: Детали реализации скрыты за интерфейсами

## Взаимодействие между слоями
- **application** использует интерфейсы из **domain/repositories** и **domain/services**
- **infrastructure** реализует интерфейсы из **domain/repositories** и **domain/services**
- **interfaces** использует компоненты из **application** для обработки запросов