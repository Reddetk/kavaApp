# Interfaces Directory

## Overview
Директория `interfaces` содержит компоненты, отвечающие за взаимодействие с внешними системами. Здесь находятся HTTP-обработчики для REST API и компоненты для работы с Kafka. Этот слой преобразует внешние запросы в вызовы сервисов приложения и форматирует результаты для внешних потребителей.

## Структура директорий

### http/
Содержит компоненты для обработки HTTP-запросов:

#### handlers/
Обработчики HTTP-запросов:

##### user_handler.go
Обработчик запросов для управления пользователями:
- `GET /api/v1/users/:id`: Получение профиля пользователя
- `POST /api/v1/users/`: Создание пользователя
- `PUT /api/v1/users/:id`: Обновление пользователя
- `DELETE /api/v1/users/:id`: Удаление пользователя

##### segment_handler.go
Обработчик запросов для работы с сегментами:
- `POST /api/v1/segments/rfm`: Выполнение RFM-сегментации
- `POST /api/v1/segments/behavior`: Выполнение поведенческой сегментации
- `GET /api/v1/segments/`: Получение всех сегментов по типу
- `GET /api/v1/segments/:id`: Получение сегмента по ID
- `GET /api/v1/segments/user/:id`: Получение сегментов пользователя

##### retention_handler.go
Обработчик запросов для анализа удержания:
- `GET /api/v1/retention/:id/churn`: Получение вероятности оттока
- `GET /api/v1/retention/:id/time`: Прогнозирование времени до события

##### clv_handler.go
Обработчик запросов для работы с CLV:
- `GET /api/v1/clv/:id`: Расчет CLV пользователя
- `POST /api/v1/clv/update`: Пакетное обновление CLV
- `GET /api/v1/clv/:id/estimate`: Оценка CLV по сценарию
- `GET /api/v1/clv/:id/history`: Получение истории CLV

#### router.go
Настройка маршрутизации HTTP-запросов:
- Определение маршрутов для всех обработчиков
- Настройка middleware для аутентификации, логирования и обработки ошибок
- Конфигурация CORS и других параметров HTTP-сервера

### kafka/
Содержит компоненты для работы с Kafka:

#### config.go
Конфигурация Kafka:
- Настройка подключения к брокерам Kafka
- Конфигурация продюсера и консьюмера
- Настройка параметров сериализации и десериализации сообщений

#### consumer.go
Потребитель сообщений Kafka:
- Подписка на топики Kafka
- Обработка сообщений о транзакциях
- Обновление метрик пользователей на основе новых транзакций
- Триггеры для пересчета сегментов и CLV

#### producer.go
Производитель сообщений Kafka:
- Отправка сообщений о событиях, связанных с пользователями
- Сериализация сообщений в формат JSON или Avro
- Обработка ошибок при отправке сообщений

#### health.go
Проверка здоровья соединения с Kafka:
- Мониторинг состояния соединения с брокерами Kafka
- Проверка доступности топиков
- Сбор метрик о работе продюсера и консьюмера

## Форматы данных

### HTTP-запросы и ответы
- Запросы и ответы в формате JSON
- Стандартизированный формат ошибок
- Пагинация для списков с использованием параметров `limit` и `offset`
- Фильтрация с использованием query-параметров

### Kafka-сообщения
- Сообщения в формате JSON или Avro
- Схемы сообщений для валидации
- Заголовки сообщений для метаданных
- Ключи сообщений для партиционирования

## Обработка ошибок
- Преобразование доменных ошибок в HTTP-статусы и сообщения об ошибках
- Логирование ошибок с контекстом
- Повторные попытки для временных ошибок
- Graceful degradation при недоступности внешних систем

## Взаимодействие с другими слоями
- Использует сервисы из слоя `application` для выполнения бизнес-операций
- Преобразует внешние запросы в вызовы методов сервисов
- Форматирует результаты сервисов для внешних потребителей
- Не зависит от слоя `infrastructure`

## Принципы реализации
1. **Разделение ответственности**: Каждый обработчик отвечает за конкретную функциональность
2. **Валидация входных данных**: Проверка корректности запросов перед вызовом сервисов
3. **Форматирование ответов**: Стандартизированный формат ответов и ошибок
4. **Безопасность**: Проверка аутентификации и авторизации для защищенных эндпоинтов